<!doctype html>
<html lang="ko">
  <head>
    <title>이벤트루프</title>
    <script>
      const onClickLoop = () => {
        console.log("시작!!!");

        // 비동기작업(매크로큐에 들어감) (덜급해!!)
        // setTimeout()을 딱 만나는 순간, 어 뭐야 얘 오래걸리는 애내? 하고 백그라운드로 바로 뺌
        // 그 중에서도 매크로큐로 뺌
        setTimeout(() => {
          // 프로미스?
          // 어 뭐야 얘 또 오래걸리는 애잖아...
          // 일단 실행해버리고,
          // .then() 부분이 프로미스 끝난 다음에 나오는 애기 때문에
          // 백그라운드로 빼버리는데
          // 그 중에서도 마이크로큐로 뺌
          new Promise((resolve) => resolve("철수")).then(
            // 콜백 함수
            // 비동기작업(마이크로큐에 들어감) (급해!!)
            () => {
              console.log("저는 Promise() setTimeout(안에서 실행) 입니다.");
            },
          );

          console.log(
            "저는 setTimeout()!! 매크로큐!! 0초 뒤에 실행될거에요!!!!",
          );
        }, 0);

        // 비동기작업(마이크로큐에 들어감)
        // 위의 Promise 부분과 동일한 원리로
        // 백그라운드, 그 중에서도 마이크로큐로 .then() 부분 빼서 넣어줌.
        new Promise((resolve) => resolve("철수")).then(
          // 콜백 함수. 마이크로큐에 실질적으로 들어가는 부분.
          () => {
            console.log(
              "저는 Promise() 1 입니다. 마이크로큐!! 0초 뒤에 실행될 거에요.",
            );
          },
        );

        // 비동기작업(매크로큐에 들어감)
        // 아 뭐야 얘도 오래걸리는 작업이네? 백그라운드
        // 근데 setTimeout, setInterval 이런애들은 뭐다? 안급하다.
        // 매크로 큐로 뺀다.
        setInterval(() => {
          console.log(
            "나는 setInterval!! 매크로큐!! 0초 마다 실행될거에요!!!!",
          );
        }, 0);

        //  ////////////////////// 엄청 오래걸리는 구간 시작 ////////////////////////////
        let sum = 0;
        for (let i = 0; i <= 9000000000; i++) {
          sum++;
        }
        //  ////////////////////// 엄청 오래걸리는 구간 끝 ////////////////////////////

        // 비동기작업(마이크로큐에 들어감)
        // 아 얘도 오래걸리네? 백그라운드
        // 근데 프로미스? 약속? 급하다. 마이크로큐에 넣자.
        new Promise((resolve) => resolve("철수")).then(() => {
          console.log(
            "저는 Promise() 2 입니다. 마이크로큐!! 0초 뒤에 실행될 거에요.",
          );
        });

        // 여기까지 와서 정리해 보면
        // 지금 들어가 있는 것들이,
        // 콜스택에는: onClickLoop()
        // 태스크 큐에는:
        // - 매크로큐: 1번순서 setTimeout(), 2번순서 setInterval()
        // - 마이크로큐: 1번순서 Promise() 1, 2번순서 Promise() 2
        console.log("끝!!!");
      };
      // 스레드가 이제 보니
      // 끝 났네?
      // 콜스택에서 함수 onClickLoop() 뺌.
      //
      // 어? 매크로큐, 마이크로큐에 뭐가 꽉 차 있네?
      // 뭐부터 빼야 되지?
      // 마이크로큐가 급한 애들이다.
      // 마이크로큐부터 빼낸다. 그리고 큐는 fifo 구조다.
      // 먼저 들어간 Promise1 부터 뺀다. (콘솔 찍고 끝남.)
      // 그 다음 Promise2 뺀다. (콘솔 찍고 끝남.)
      // 마이크로 큐 텅텅 빔.
      //
      // 이제 매크로큐 setTimeout() 뺌. (어? 이 안에 프로미스 있네? 나중에 해야지. 마이크로큐에 넣자.)
      // 마이크로큐에 타이머 안의 Promise 추가됨.
      //
      // 마이크로큐는 항상 매크로큐보다 먼저 실행된다. 급하니까.
      // 마이크로큐에서 (타이머 안의 Promise)를 빼냄. (콘솔 찍고 끝남.)
      //
      // 마이크로큐 텅텅 비었네?
      // 다시 매크로 큐로 가보니 setInterval() 남아있음. 이거 빼냄.
      // 0초마다 콘솔 찍히는 setInterval() 이 실행됨.
    </script>
  </head>
  <body>
    <button onClick="onClickLoop()">이벤트루프</button>
  </body>
</html>
